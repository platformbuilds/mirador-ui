project: mirador-ui
owner: you
timezone: Asia/Kolkata
goals:
  - Build a configurable KPI dashboard with user-defined KPIs
  - Add MIRA chat (SSE) and Incident timeline views
  - Replace local mocks with real mirador-core APIs when ready
environments:
  dev:
    start: "pnpm dev:all"
    storybook: "pnpm storybook"
    proxy: "vite proxy -> http://localhost:8787"
  prod:
    build: "pnpm build"
    serve: "nginx static + reverse proxy /api/v1 -> mirador-core:8080"
dirs:
  - src/lib
  - src/state
  - src/components
  - src/pages
  - mock
feature_flags:
  - FEATURE_MIRA_CHAT
  - KPI_BUILDER
  - INCIDENT_VIEW

milestones:
  - id: M0
    name: Bootstrap & Mock API
    done: true
    includes:
      - next_01_add_storybook.sh
      - next_02_add_mock_api.sh
  - id: M1
    name: Chat & Incident Views
    done: true
    includes:
      - next_03_add_chat_and_incident.sh
  - id: M2
    name: Batch & Persist KPI Defs
    done: true
    includes:
      - next_04_batch_and_persist.sh
  - id: M3
    name: Production Readiness
    done: false

tasks:
  - id: T1
    title: Point proxy to real mirador-core
    type: config
    files:
      - vite.config.ts
      - .env.local
    diff:
      VITE_API_BASE_URL: "http://mirador-core:8080"
    acceptance:
      - curl "${VITE_API_BASE_URL}/api/v1/health" returns 200
    estimate_h: 0.5
  - id: T2
    title: Central API client with auth/trace
    type: code
    files:
      - src/lib/http.ts
    content:
      - "axios instance with baseURL from import.meta.env.VITE_API_BASE_URL"
      - "request interceptor adds Authorization, X-Trace-Id"
      - "retry/backoff (3 attempts) for 502/503/504"
    acceptance:
      - "All API calls migrate to http.ts"
    estimate_h: 1.5
  - id: T3
    title: Swap mocks to real endpoints
    type: integration
    endpoints:
      - POST /api/v1/metrics/batch
      - GET|POST|PUT|DELETE /api/v1/kpi/defs
      - POST /api/v1/mira/chat?stream=1
      - POST /api/v1/rca/investigate
    steps:
      - "Disable mock/server.js by not starting dev:mock"
      - "Set Vite proxy to mirador-core"
    acceptance:
      - "Home grid loads values via batch"
      - "KPI Builder persists to core"
      - "Chat streams tokens from MIRA"
      - "Incident loads timeline from correlation engine"
    estimate_h: 3
  - id: T4
    title: KPI Card edit/delete & duplicate
    type: ui
    files:
      - src/components/KpiCard/index.tsx
      - src/pages/Home/index.tsx
    actions:
      - "⋮ menu: Edit, Duplicate, Delete"
      - "Confirm modal on delete"
    acceptance:
      - "Edit updates existing def"
      - "Duplicate creates new id with suffix"
    estimate_h: 2
  - id: T5
    title: Grid layout (drag/resize) with persistence
    type: ui
    deps: [T4]
    libs:
      - react-grid-layout
    files:
      - src/components/KpiGrid/index.tsx
    persistence:
      - "save layout back into def.layout and upsert"
    acceptance:
      - "Layout survives refresh"
    estimate_h: 2
  - id: T6
    title: Sparkline on KPI Cards
    type: ui
    files:
      - src/components/KpiCard/Sparkline.tsx
      - src/components/KpiCard/index.tsx
    data:
      - "use spark array from batch results"
    acceptance:
      - "SVG line renders; hidden if data missing"
    estimate_h: 1
  - id: T7
    title: Chat UX polish
    type: ui
    files:
      - src/pages/Chat/index.tsx
      - src/lib/markdown.ts
    features:
      - "Markdown render (answer)"
      - "Stop/Retry buttons"
      - "Thumbs feedback -> POST /api/v1/mira/feedback"
      - "Session list (left rail) with local cache"
    estimate_h: 3
  - id: T8
    title: Incident Timeline interactions
    type: ui
    files:
      - src/components/SimpleTimeline/index.tsx
    features:
      - "Brush/zoom"
      - "Tooltips with exact values"
      - "Anomaly markers; click → explain"
    estimate_h: 3
  - id: T9
    title: Design tokens & theming
    type: design
    files:
      - tailwind.config.js
      - src/styles/tokens.css
    features:
      - "Figma tokens mapped to Tailwind"
      - "light/dark via data-theme"
    estimate_h: 2
  - id: T10
    title: ErrorBoundary + Toasts
    type: infra
    files:
      - src/components/system/ErrorBoundary.tsx
      - src/components/system/Toast.tsx
      - src/lib/errors.ts
    acceptance:
      - "API failures surface as toasts"
      - "render fallback on crashes"
    estimate_h: 2
  - id: T11
    title: Auth plumb-in (JWT)
    type: integration
    files:
      - src/lib/auth.ts
      - src/lib/http.ts
      - src/App.tsx
    features:
      - "store JWT in memory only"
      - "role-based guards for builder/edit"
    estimate_h: 2
  - id: T12
    title: A11y & i18n scaffold
    type: quality
    files:
      - src/i18n/index.ts
      - src/i18n/en.json
    acceptance:
      - "landmarks, aria labels, keyboard focus"
      - "strings moved to en.json"
    estimate_h: 2
  - id: T13
    title: Testing pass
    type: qa
    libs:
      - vitest
      - @testing-library/react
      - playwright
    coverage:
      - "KpiCard, KpiBuilder, Chat stream, Incident timeline"
    estimate_h: 4
  - id: T14
    title: Docker & Nginx
    type: ops
    files:
      - Dockerfile
      - nginx.conf
    acceptance:
      - "Static build served at /"
      - "Proxy /api/v1 -> mirador-core"
    estimate_h: 2

commands:
  dev:
    storybook: "pnpm storybook"
    app: "pnpm dev:all"
  switch_to_core:
    - "pnpm run dev:fe"
    - "STOP mock: do not run pnpm dev:mock"
    - "vite server.proxy -> http://mirador-core:8080"
  test:
    unit: "pnpm test"
    e2e: "pnpm exec playwright test"
  build:
    prod: "pnpm build"
    preview: "pnpm preview"

routes_to_test:
  - path: "#/"
    checks:
      - "KPI grid renders"
      - "Batch call fired once"
  - path: "#/kpi-builder"
    checks:
      - "Create KPI -> appears on Home"
      - "Validation errors shown"
  - path: "#/chat"
    checks:
      - "Streaming tokens accumulate"
      - "Stop/Retry works"
  - path: "#/incident"
    checks:
      - "Timeline loads and displays"
      - "Tooltip/zoom functional (after T8)"

api_contracts:
  kpi_defs:
    list: "GET /api/v1/kpi/defs -> { defs: KpiDef[] }"
    upsert: "POST /api/v1/kpi/defs -> KpiDef"
    update: "PUT /api/v1/kpi/defs/:id -> KpiDef"
    delete: "DELETE /api/v1/kpi/defs/:id -> { ok: true }"
  metrics:
    batch: "POST /api/v1/metrics/batch -> { results: [{ id, value, spark? }] }"
  mira:
    chat_stream: "POST /api/v1/mira/chat?stream=1 (SSE)"
    feedback: "POST /api/v1/mira/feedback -> { ok: true }"
  rca:
    investigate: "POST /api/v1/rca/investigate -> RcResponse"

risks:
  - "Leaving formula evaluation client-side; move to mirador-core for audit and safety"
  - "Long SSE sessions without backoff; add stop + retry with jitter"
  - "Grid layout perf with many KPIs; batch + virtualize if >40 cards"
  - "Air-gapped fonts/assets; ensure no external CDNs in CSS/HTML"

definition_of_done:
  - "No usage of mock server in prod build"
  - "All API calls go through central http client with auth and tracing"
  - "KPI grid loads via batch and respects layout persistence"
  - "Chat supports streaming + feedback"
  - "Incident timeline is interactive and explanatory"
  - "Storybook covers KPI components"
  - "CI: typecheck, unit tests, build"

next_3_actions:
  - "Implement T2: central http.ts with auth + retry"
  - "Implement T4: KPI edit/delete/duplicate UI"
  - "Implement T5: grid drag/resize + persistence"